version: '3'

tasks:
  clean:
    desc: 'ğŸ§¹ Clean project'
    cmds:
      - flutter clean

  clean-generated:
    desc: 'ğŸ§½ Remove generated code'
    aliases: [ cleang ]
    cmds:
      - rm -rf lib/generated

  clean-all:
    desc: 'ğŸ§¼ Clean project and remove generated code'
    aliases: [ cleana ]
    cmds:
      - task: clean
      - task: clean-generated

  install:
    desc: 'ğŸ“¦ï¸ Get dependencies in all packages'
    cmds:
      - ./scripts/get_dependencies.sh

  format:
    desc: 'ğŸ’¼ Format code'
    aliases: [ fmt ]
    cmds:
      - dart format -l 120 .

  fix:
    desc: 'ï¸ğŸ‘¨â€ğŸ”§ Fix lint problems'
    cmds:
      - dart fix --apply

  generate-localization:
    desc: 'ğŸŒï¸ Generate l10n'
    aliases: [ genloc ]
    cmds:
      - flutter gen-l10n
      - cd packages/ui_kit && flutter gen-l10n

  generate-code:
    desc: 'ğŸ‘· Run build_runner'
    aliases: [ genc ]
    cmds:
      - dart run build_runner build --delete-conflicting-outputs
      - task: generate-code-ui-kit
      - task: generate-code-storybook

  generate-code-ui-kit:
    desc: 'ğŸ‘· Run build_runner in ui_kit'
    cmd: dart run build_runner build --delete-conflicting-outputs
    dir: packages/ui_kit

  generate-code-storybook:
    desc: 'ğŸ‘· Run build_runner in storybook'
    cmd: dart run build_runner build --delete-conflicting-outputs
    dir: storybook

  generate-splash:
    desc: 'ğŸ¨ Generate native code for Splash screen'
    cmd: dart run flutter_native_splash:create

  generate:
    desc: 'ğŸš§ Generate everything'
    aliases: [ gen ]
    cmds:
      # First step is a fix for this issue: https://github.com/dart-lang/build/issues/2835
      - rm .dart_tool/package_config.json
      - task: clean-generated
      - task: generate-localization
      - task: generate-code
      - task: generate-splash
      - task: format

  analyze:
    desc: 'ğŸ‘® Run flutter analyze'
    cmds:
      - ./scripts/flutter_analyze.sh

  test:
    desc: 'ğŸ’ Run tests with coverage'
    cmds:
      - ./scripts/test.sh

  check:
    desc: 'ğŸ”¦ Run checks'
    cmds:
      - task: analyze
      - task: test

  build-android:
    desc: 'ğŸ¤– Build Android apk'
    vars:
      PACKAGE_FORMAT: '{{ default "apk" .PACKAGE_FORMAT }}'
    cmds:
      - flutter build {{ .PACKAGE_FORMAT }} --flavor {{ .FLAVOR }} --build-number={{ .BUILD_NUMBER }} --build-name={{ .BUILD_NAME }}

  pod-install:
    desc: 'ğŸ¥œ Install cocoa pods'
    dir: apps/app/ios
    cmds:
      - flutter precache --ios
      - pod install

  build-ios:
    desc: 'ğŸ Build iOS app'
    cmds:
      - flutter build ios --flavor {{ .FLAVOR }} --build-number={{ .BUILD_NUMBER }} --build-name={{ .BUILD_NAME }}

  prepare-no-check:
    aliases: [ pnc ]
    desc: 'ğŸ§‘â€ğŸ³ Clean project, get dependencies, and generate all the code'
    cmds:
      - task: clean-all
      - task: install
      - task: generate

  prepare:
    desc: 'ğŸ‘Œ Clean project, get dependencies, generate all the code, and run checks'
    cmds:
      - task: prepare-no-check
      - task: check

  storybook-run:
    aliases: [ sbr ]
    desc: 'âœ¨ Run Storybook in browser'
    cmds:
      - .flutter run -d chrome
    dir: storybook

  storybook-build:
    aliases: [ sbb ]
    desc: 'ğŸ§š Build Storybook for production'
    cmds:
      - .flutter build web
    dir: storybook

  gh-set-secrets:
    desc: 'ğŸ¤ Set GitHub Actions Secrets from ./github/.env'
    cmds:
      - gh secret set -f .env
    dir: .github
