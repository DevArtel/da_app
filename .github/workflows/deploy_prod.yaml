name: Build and deploy to TestFlight/Google play alpha

on:
  push:
    tags:
      - '*.*.*-prod'

jobs:
  extract-version:
    runs-on: ubuntu-latest
    outputs:
      BUILD_NAME: ${{steps.extract.outputs.build-name }}
      BUILD_NUMBER: ${{steps.extract.outputs.build-number }}
    steps:
      - name: 'ðŸ›’ Checkout'
        uses: actions/checkout@v3
      - name: 'ðŸ”¢ Extract version and build number'
        id: extract
        uses: ./.github/actions/extract-version
        with:
          flavor: prod
      - name: 'ðŸ†• Create Sentry release'
        uses: ./.github/actions/release-sentry
        with:
          environment: prod
          token: ${{ secrets.SENTRY_AUTH_TOKEN }}
          version: ${{ steps.extract.outputs.build-name }}
          build-number: ${{ steps.extract.outputs.build-number }}
      - name: 'ðŸ’¢ Report error'
        uses: someimportantcompany/github-actions-slack-message@v1
        if: failure()
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: 'Failed to deploy staging release: failed to create release'
          color: failure

  build-and-deploy:
    uses: ./.github/workflows/build_and_deploy.yaml
    needs: extract-version
    with:
      build-name: ${{ needs.extract-version.outputs.BUILD_NAME }}
      build-number: ${{ needs.extract-version.outputs.BUILD_NUMBER }}
      flavor: prod
      android-format: appbundle
      deploy: true
    secrets: inherit
