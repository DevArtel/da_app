name: Build and deploy to Firebase

on:
  push:
    tags:
      - '*.*.*-staging'

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      BUILD_NAME: ${{ steps.extract.outputs.build-name }}
      BUILD_NUMBER: ${{ steps.extract.outputs.build-number }}
      CHANGELOG: ${{ steps.shorten_changelog.outputs.CHANGELOG }}
    steps:
      - name: '🛒 Checkout'
        uses: actions/checkout@v3
      - name: '🧶 Setup node'
        uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: '🔢 Extract version and build number'
        id: extract
        uses: ./.github/actions/extract-version
        with:
          flavor: staging
      - name: '🆕 Generate changelog'
        id: changelog
        uses: metcalfc/changelog-generator@v3.0.0
        with:
          mytoken: ${{ secrets.GITHUB_TOKEN }}
      - name: '🆔 Create release'
        id: create_release
        uses: actions/create-release@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: ${{steps.extract.outputs.build-name }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
      - name: '🆕 Create Sentry release'
        uses: ./.github/actions/release-sentry
        with:
          environment: staging
          token: ${{ secrets.SENTRY_AUTH_TOKEN }}
          version: ${{ steps.extract.outputs.build-name }}
          build-number: ${{ steps.extract.outputs.build-number }}
      - name: '🖨️ Trim commits links from the changelog'
        id: shorten_changelog
        run: |
          set -o noglob
          log=$(cat << "EOF" | sed -e "s/.*) - /- /"
          ${{ steps.changelog.outputs.changelog }}
          EOF
          )
          log="${log//'%'/'%25'}"
          log="${log//$'\n'/'%0A'}"
          log="${log//$'\r'/'%0D'}"
          log="${log//$'`'/'%60'}"
          log="${log//$'"'/'%22'}"
          echo "CHANGELOG=$log" >> $GITHUB_OUTPUT
      - name: '💢 Report error'
        uses: someimportantcompany/github-actions-slack-message@v1
        if: failure()
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: 'Failed to deploy staging release: failed to create release'
          color: failure

  build-and-deploy:
    uses: ./.github/workflows/build_and_deploy.yaml
    needs: create-release
    with:
      build-name: ${{ needs.create-release.outputs.BUILD_NAME }}
      build-number: ${{ needs.create-release.outputs.BUILD_NUMBER }}
      changelog: ${{ toJSON(needs.create-release.outputs.CHANGELOG) }}
      flavor: staging
      android-format: apk
      deploy: true
    secrets: inherit

  release-on-youtrack:
    runs-on: ubuntu-latest
    needs: [ build-and-deploy, create-release ]
    steps:
      - name: '🛒 Checkout'
        uses: actions/checkout@v3
      - name: '🧶 Setup node'
        uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: '📋 Release on YouTrack'
        run: |
          cd scripts/youtrack
          npm install
          node release.js ${{ needs.create-release.outputs.BUILD_NAME }}
        env:
          YOUTRACK_TOKEN: ${{ secrets.YOUTRACK_TOKEN }}
      - name: '💢 Report error'
        uses: someimportantcompany/github-actions-slack-message@v1
        if: failure()
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: 'Failed to deploy staging release: failed to create youtrack release'
          color: failure
